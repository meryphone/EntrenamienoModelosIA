---
title: "Proyecto AC"
author:
  - "Maria Capilla Zapata"
  - "Gloria Sánchez Alonso"
  - "Samuel Avilés Conesa"
date: "`r Sys.Date()`"
output: 

  html_document:
      toc: true
      toc_float: true
      theme: spacelab
      highlight: kate
      df_print: paged
      number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introdución

## Carga de la base de datos.

Primeramente comenzamos cargando la base de datos, guardando en distintas variables los datos que utilizaremos para el entrenamiento y para probar el modelo. Añadimos la opción "na.strings=?" para sustituir los valores desconocidos
por NA y poder ser eliminado posteriormente.

```{r}
credit = read.table("crx.data", sep = ",", na.strings ="?")
credit.trainIdx<-readRDS("credit.trainIdx")
#credit.Datos.Train<-credit[credit.trainIdx,]
#credit.Datos.Test<-credit[-credit.trainIdx,]
```

Después comprobamos que efectivamente, tenemos 553 observaciones.

```{}
nrow(credit.Datos.Train)
```

# Preprocesado de datos


Primero tenemos que analizar que variables tiene credit en su base de datos

```{r}
str(credit)
```

Observamos al importar la base de datos el tipo de datos de las variables es incorrecto, además de que hay datos incompletos, por lo que procedemos a corregirlo ejecutando:

```{r}
credit = na.omit(credit)
credit["V1"] = lapply(credit["V1"], FUN = as.factor)
credit["V2"] = lapply(credit["V2"], FUN = as.numeric)
credit["V3"] = lapply(credit["V3"], FUN = as.numeric)
credit["V4"] = lapply(credit["V4"], FUN = as.factor)
credit["V5"] = lapply(credit["V5"], FUN = as.factor)
credit["V6"] = lapply(credit["V6"], FUN = as.factor)
credit["V7"] = lapply(credit["V7"], FUN = as.factor)
credit["V8"] = lapply(credit["V8"], FUN = as.numeric)
credit["V9"] = lapply(credit["V9"], FUN = as.factor)
credit["V10"] = lapply(credit["V10"], FUN = as.factor)
credit["V11"] = lapply(credit["V11"], FUN = as.numeric)
credit["V12"] = lapply(credit["V12"], FUN = as.factor)
credit["V13"] = lapply(credit["V13"], FUN = as.factor)
credit["V14"] = lapply(credit["V14"], FUN = as.numeric)
credit["V15"] = lapply(credit["V15"], FUN = as.numeric)
credit["V16"] = lapply(credit["V16"], FUN = as.factor)
str(credit)
```

Ahora observamos que la variable V4 solo tiene 3 niveles y debería de tener 4, es decir, hay algún valor que nunca aparece en los datos. Viendo en la descripción de la BBDD podemos ver que debería aparecer el valor "t". Lo añadimos:

```{r}
levels(credit$V4)<-c(levels(credit$V4),"t")
str(credit$V4)
str(credit)
```

Una vez corregido el tipos de datos, añadido las categorías faltantes y quitado los valores incompletos y nulos nos queda la siguiente base de datos:

```{r}
summary(credit)
str(credit)
```

##  Análisis univariable

### Análisis V2

```{r}
summary(credit$V2)
```


- **Rango de valores**: La variable `V2` tiene un rango bastante amplio, con valores que van desde 13.75 hasta 76.75.

- **Distribución de los datos**:

- La **media** (31.50) está algo cerca de la **mediana** (28.42), lo que sugiere una distribución relativamente simétrica pero con una ligera tendencia hacia valores mayores, especialmente considerando que el máximo es bastante más alto que el tercer cuartil.

- **Cuartiles**: La diferencia entre el primer cuartil (22.58) y el tercer cuartil (38.25) indica que el 50% intermedio de los valores de `V2` se encuentra en un rango moderado, entre 22.58 y 38.25.
Posibles valores atípicos:
- Dado que el máximo (76.75) está bastante alejado de la mediana (28.42) y del tercer cuartil (38.25), esto podría indicar la presencia de valores atípicos en el extremo superior de la distribución.

Para estar seguros de la distribución que sigue v2, creamos un histograma de dicha variable:

```{r}
library(ggplot2)
myhist = ggplot(data=credit,aes(V2)) +
  geom_histogram(col="orange",fill="orange",alpha=0.2) + 
  labs(title="Histograma para V2", y="Count") 
myhist = myhist + geom_vline(xintercept = mean(credit$V2),
                             col="blue",linetype="dashed")
myhist = myhist + geom_vline(xintercept = median(credit$V2),
                             col="red",linetype="dashed")
myhist
```

- La distribución es **asimétrica a la derecha** o **sesgada positivamente,** como se había inferido anteriormente. La mayoría de los valores están en el rango bajo (de 15 a 40), y solo unos pocos valores están en el rango superior.

- Hay algunos valores dispersos hacia la derecha que elevan el promedio, lo que sugiere que existen **valores atípicos** o extremos en el extremo superior.

```{r}
myplot = ggplot(data=credit,aes(sample=V2)) +
  ggtitle("QQ plot para V2") +
  geom_qq() + 
  stat_qq_line() + 
  xlab("Distribución teórica") + ylab("Distribución muestral")
myplot
```

- El gráfico Q-Q muestra cómo se distribuyen los datos en comparación con una **distribución normal teórica**.

- La curva de puntos se desvía hacia arriba en el extremo derecho, lo que confirma el **sesgo a la derecha** (positivamente sesgado). Los valores en el extremo superior no siguen la línea diagonal, indicando que hay algunos valores altos que se desvían de la normalidad.

- La parte inferior del gráfico muestra algunos puntos ligeramente por debajo de la línea, lo que indica que la distribución no es perfectamente simétrica en esa zona, aunque el sesgo es más pronunciado hacia la derecha.

### Análisis de V3

Características de nuestros datos:

- La media de esta variable, como se puede observar 4.830, es mayor que la mediana, que es 2.835, lo que indica que es una distribución sesgada hacia la derecha (algunos de los valores que son mas altos están haciendo que la media aumente).

- Los valores de esta variable se encuentran en un rango entre 0(min) y 28(max).

- El primer cuartil(1.040) y el tercer cuartil(7.500) indican que la mayoría de los datos se encuentran entre esos valores. Respecto a los valores atipicos, se nota que existen ya que el valor mas alto que es 28 supera de forma significativa el tercer cuartil.

- La mayoría de los datos de V3 parecen concentrarse en valores relativamente bajos, con unos pocos valores mucho mayores que podrían ser considerados outliers o valores extremos.

    Para confirmar los valores atípicos y como se distribuyen los datos en la variable representamos los valores en el histograma:

```{r}
myhist=ggplot(data=credit, aes(x = V3)) +
  geom_histogram(col = "orange", fill = "orange", alpha = 0.2,
                 breaks = seq(0, 30, by = 1)) +
  labs(title = "Histograma para el análisis de la variable V3", y = "Count") 

# Marca el valor de la media con una línea azul vertical
myhist <- myhist + geom_vline(xintercept = mean(credit$V3),
                              col = "blue", linetype = "dashed")

# Marca el valor de la mediana con una línea roja vertical
myhist <- myhist + geom_vline(xintercept = median(credit$V3),
                              col = "red", linetype = "dashed")
myhist
```

Para poder intuir si una muestra sigue una determinada distribución estadística se pueden usar los diagramas del tipo Q−Q.

```{r}
ggplot(credit, aes(sample = V3)) +
  stat_qq() +
  stat_qq_line(color = "blue", linetype = "dashed") +
  labs(title = "Diagrama Q-Q de V3", x = "Cuantiles Teóricos", y = "Cuantiles Muestrales")
```

### Análisis V8

```{r}
summary(credit$V8)
```

- Como podemos observar en el resumen de la variable, la media es bastante superior a la mediana esto es debido a los     valores atípicos, también lo podemos observar en el valor máximo que es 28.50. 
- También podemos ver en los cuartiles como nos anuncian que hay muchos datos atípicos ya que los cuartiles están        cercanos a la media y a la mediana pero el valor máximo es muy dispar. 
Para poder ver como se distribuyen los datos en nuestra variable creamos los siguientes plots:

```{r}
myhist = ggplot(data=credit, aes(x = V8)) +
  geom_histogram(col="orange", fill="orange", alpha=0.2,
                 breaks=seq(0, 30, by=1)) + 
  labs(title="Histograma para el análisis de la variable V8", y="Count") 

# Marca el valor de la media con una línea azul vertical
myhist = myhist + geom_vline(xintercept = mean(credit$V8),
                             col="blue", linetype="dashed")

# Marca el valor de la mediana con una línea roja vertical
myhist = myhist + geom_vline(xintercept = median(credit$V8),
                             col="red", linetype="dashed")


# Mostrar el histograma
myhist
```

```{r}
ggplot(data = credit, aes(sample = V8)) +
  ggtitle("QQ plot para variable V8") +
  stat_qq() + 
  stat_qq_line() +
  xlab("Distribución teórica") +
  ylab("Distribución muestral")

```

- Como podemos observar en el histograma estamos ante una distribución asimétrica positiva, sesgada a la derecha, ya  que la mayor parte de los datos se encuentran en valores más cercanos a 0 mientras que los valores más altos son     menos frecuentes.
- Aunque la mayoría de los datos se encuentran en valores bajos, hay una cola larga en el extremo derecho del          histograma hasta valores cercanos a 30, estos valores atípicos sería necesario limpiarlos por que ensucian la        muestra.
- A su vez el diagrama QQ nos reafirma lo analizado anteriormente mostrando claramente como para valores mas  altos    los datos se alejan de la distribución teórica normal representada por la recta.

## Analisis multivariable
```{r}
numeric_data <- credit[, c("V2", "V3", "V8", "V11", "V14", "V15", "V16")]


if (!require(GGally)) install.packages("GGally")
library(GGally)

# Generar el gráfico de pares con colores según la columna V16
ggpairs(numeric_data, aes(color = V16), title = "Relación entre atributos en el análisis de la BBDD credit")
```


Se ha coloreado el gráfico mediante la variable categórica V16 la cual determina si la compra fue
aprobada o no.


1. Correlaciones entre Variables

La matriz de correlación muestra los coeficientes de correlación entre cada par de atributos. Los valores positivos y negativos indican la dirección de la relación, mientras que los asteriscos reflejan la significancia estadística:
  V2 y V8: La correlación es de 0.418 para toda la muestra y de 0.463 en la clase positiva (+), lo cual indica una     correlación moderada positiva. Esto significa que a medida que el valor de V2 aumenta, el valor de V8 tiende a       aumentar también, especialmente en las observaciones de la clase +.
  V3 y V8: Con una correlación de 0.301 general y de 0.371 en la clase +, muestra otra relación moderada positiva.
  V8 y V11: La correlación es de 0.327 en general y de 0.264 para la clase +, indicando una relación positiva en la    que los valores de V8 y V11 tienden a aumentar juntos.
  Relaciones con V14: Existen correlaciones negativas entre V14 y otras variables, como V2 (-0.085 general) y V8        (-0.217 general), lo que indica que a medida que V14 aumenta, estas variables tienden a disminuir.

2. Distribución de Atributos en la Diagonal

   La diagonal muestra los histogramas de cada atributo, desglosados por clase (+ y -), lo que permite observar su distribución:
        V2: Tiene una distribución sesgada a la derecha para ambas clases, con valores más altos en la clase + (azul) que en la clase - (rojo).
        V8: Muestra también un sesgo positivo significativo, especialmente en la clase +.
        V14 y V15: Presentan distribuciones con valores concentrados en el rango bajo, pero la clase + muestra una mayor dispersión en comparación con la clase -.

3. Relación entre Variables por Clase

  Los colores permiten visualizar cómo se distribuyen las clases + (azul) y - (rojo) en los gráficos de dispersión. Algunas observaciones clave incluyen:
        Separación en la Distribución: En algunos pares, como V2 y V3, la clase + tiende a agruparse en rangos más altos de V2, mientras que la clase - está más dispersa en rangos bajos.
        Grupos Visibles en V8 y V11: Los puntos en V8 y V11 muestran que la clase + tiene una mayor concentración en valores altos en comparación con la clase -, lo cual podría ser útil para la clasificación.

4. Patrones Útiles para la Clasificación

  El gráfico muestra que algunos atributos pueden ayudar a discriminar entre la clase + y la -. Por ejemplo:
        V2, V8 y V11: Estas variables muestran diferencias de dispersión o concentración entre las clases, lo que            indica que pueden ser útiles para la clasificación de crédito.
        Distribuciones Dispares: Las diferencias en las distribuciones de V2, V8, y V14 entre las clases sugieren que         estas variables podrían ayudar a identificar si un crédito será aprobado o denegado.

## Tratamiento de valores extremos y atípicos.

Para continuar, vamos a comenzar con el tratamiento de valores extremos y atípicos debido
a que los valores nulos y desconocidos ya han sido eliminados. 
Para continuar, vamos a calcular el valor limite superior e inferior para considerarlos atípicos. Vamos a repetir el cálculo con todas las variables númericas de la BBDD.

### Variable V2, V3 y V14
```{r}
Q1=quantile(credit$V2,0.25)
Q3=quantile(credit$V2,0.75)
RIC=Q3-Q1
limiteInferior=Q1-1.5*RIC
limiteSuperior=Q3+1.5*RIC
atipicosv2=credit$V2[credit$V2<limiteInferior | credit$V2>limiteSuperior] 
percAtipicos=100*length(atipicosv2)/length((credit$V2))
print(paste("El porcentaje de datos atípicos para V2 es = ",percAtipicos))

```
```{r}
Q1=quantile(credit$V3,0.25)
Q3=quantile(credit$V3,0.75)
RIC=Q3-Q1
limiteInferior=Q1-1.5*RIC
limiteSuperior=Q3+1.5*RIC
atipicosv3=credit$V3[credit$V3<limiteInferior | credit$V3>limiteSuperior] 
percAtipicos=100*length(atipicosv3)/length((credit$V3))
print(paste("El porcentaje de datos atípicos para V3 es = ",percAtipicos))
```

```{r}
Q1=quantile(credit$V14,0.25)
Q3=quantile(credit$V14,0.75)
RIC=Q3-Q1
limiteInferior=Q1-1.5*RIC
limiteSuperior=Q3+1.5*RIC
atipicosv14=credit$V14[credit$V14<limiteInferior | credit$V14>limiteSuperior] 
percAtipicos=100*length(atipicosv14)/length((credit$V14))
print(paste("El porcentaje de datos atípicos para V14 es = ",percAtipicos))
```

  Como podemos ver el **porcentaje de valores atípicos** es muy bajo. Por ello, vamos
  a mantener los datos atípicos intactos para estas variables, ya que no merece
  la pena tratarlos al ser un porcentaje tan pequeño,pueden representar variabilidad
  real y natural en los datos. En caso de tratarlos, podríamos perder precisión e información
  valiosa necesaria por el modelo para aprender sobre situaciones fuera de lo común.


### Variable V8
```{r}
Q1=quantile(credit$V8,0.25)
Q3=quantile(credit$V8,0.75)
RIC=Q3-Q1
limiteInferior=Q1-1.5*RIC
limiteSuperior=Q3+1.5*RIC
atipicosv8=credit$V8[credit$V8<limiteInferior | credit$V8>limiteSuperior] 
percAtipicos=100*length(atipicosv8)/length((credit$V8))
print(paste("El porcentaje de datos atípicos es = ",percAtipicos))
```
```{r}
ggplot(credit, aes(x = V8)) +
  geom_histogram(bins = 30, fill = "orange", color = "black", alpha = 0.7) +
  labs(title = "Histograma de V8 original", x = "V8 (original)", y = "Frecuencia")

```

- Una vez analizados los datos expuestos, vemos que el porcentaje de datos atípicos
  es relativamente alto. Por lo tanto, hemos decidido llevar a cabo una normalización
  $min-max$ debido a que la representación del histograma de la variable muestra una 
  distribución altamente sesgada hacia la derecha, donde la mayor parte de los valores
  estan cerca de 0. Se realiza para que la variable v8 sea mas interpretable y consistente.

```{r}
#Normalización min/max
credit$V8 <- (credit$V8 - min(credit$V8)) / (max(credit$V8) - min(credit$V8))
min(credit$V8)  
max(credit$V8)  
```
Los resultados que hemos obtenido (minimo = 0 y maximo = 1) indican que la 
normalización $min-max$ para la variable V8 se ha realizado correctamente.

```{r}

ggplot(credit, aes(x = V8)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Histograma de V8 Normalizada", x = "V8 (normalizada)", y = "Frecuencia")

```

Al realizar el histograma, podemos comprobar que la forma de la distribución original
sigue presente, habiendo acotado el rango de valores correctamente sin perder las 
característica naturales de la variable.

### Variable V11

```{r}
Q1=quantile(credit$V11,0.25)
Q3=quantile(credit$V11,0.75)
RIC=Q3-Q1
limiteInferior=Q1-1.5*RIC
limiteSuperior=Q3+1.5*RIC
atipicosv11=credit$V11[credit$V11<limiteInferior | credit$V11>limiteSuperior] 
percAtipicos=100*length(atipicosv11)/length((credit$V11))
print(paste("El porcentaje de datos atípicos es = ",percAtipicos))
library(e1071)
# Asimetría antes de la transformación
skewness(credit$V11)
```

```{r}
ggplot(credit, aes(x = V11)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "black", alpha = 0.7) +
  labs(title = "Histograma de la Variable V11", x = "V11", y = "Frecuencia") +
  theme_minimal()
```

Observando el histograma y el porcentaje de valores atípicos, nos damos cuenta 
que la distribución de los datos tiene una asimetría hacia la derecha. Debido al
gran porcentaje de atípicos obtenido y a la alta asimetría, decidimos aplicar 
una transformación logarítmica ya que:

- Reduce la asimetría y hace que la distribución sea más simétrica.
- Limita el impacto de valores atípicos.
- Facilita la interpretación en términos relativos.


```{r}
credit$V11 <- log(credit$V11 + 1)  # +1 para evitar log(0) en valores cercanos a cero
ggplot(credit, aes(x = V11)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "black", alpha = 0.7) +
  labs(title = "Histograma de la Variable V11 transformada", x = "V11", y = "Frecuencia") +
  theme_minimal()
```

```{r}
# Calcular el porcentaje de valores atípicos para V11
Q <- quantile(credit$V11, c(0.25, 0.75))
IQR <- Q[2] - Q[1]
lim_inf <- Q[1] - 1.5 * IQR
lim_sup <- Q[2] + 1.5 * IQR

porc_atipicos <- mean(credit$V11 < lim_inf | credit$V11 > lim_sup) * 100
porc_atipicos
skewness(credit$V11)
```

Como podemos comprobar, hemos reducido ampliamente la asimetría así como los valores
atípicos. El porcentaje es significativamente menor que antes. Lo podemos ver en el
histograma realizado despues de aplicar la transformación y en el cálculo de asimetría 
y porcentaje de atípicos.

  
### Variable V15

```{r}
Q1=quantile(credit$V15,0.25)
Q3=quantile(credit$V15,0.75)
RIC=Q3-Q1
limiteInferior=Q1-1.5*RIC
limiteSuperior=Q3+1.5*RIC
atipicosv15=credit$V15[credit$V15<limiteInferior | credit$V15>limiteSuperior] 
percAtipicos=100*length(atipicosv15)/length((credit$V15))
print(paste("El porcentaje de datos atípicos es = ",percAtipicos))
```
```{r}
ggplot(credit, aes(x = V15)) +
  geom_histogram(bins = 30, fill = "skyblue", color = "black", alpha = 0.7) +
  labs(title = "Histograma de la Variable V15", x = "V15", y = "Frecuencia") +
  theme_minimal()
```

Analizando el gráfico obtenido podemos ver que la mayor parte de los valores de 
la variable se encuentran cercanos a 0 pero tenemos ciertos valores muy superiores.
Debido a que no estamos seguros acerca de si estos valores son significativos o no
vamos a aplicar una transformación de raíz cuadrada ya que suaviza los valores altos
sin comprimir en exceso la distribución y reduce la asimetría en distribuciones como esta
sesgadas a la derecha.
```{r}
credit$V15 <- sqrt(credit$V15)
ggplot(credit, aes(x = V15)) +  # V15 es la variable transformada
  geom_histogram(bins = 30, fill = "orange", color = "black", alpha = 0.7) +
  labs(title = "Histograma de V15 Transformada (Raíz Cuadrada)", x = "V15 (Transformada)", y = "Frecuencia") +
  theme_minimal()
```

Como observamos en el histograma dibujado, se ha logrado una compresión de los valores
sin perder la forma de la distribución aunque si se ha suavizado la cola hacia la derecha.
La frecuencia concentrada en valores bajos sigue siendo similar, conservando así la característica
natural de la variable.

## Eliminación de variables superfluas

## Transformacion justificada de los datos

# Entrenamiento de modelos/técnicas
